<html>
<head>
<title>WebViewExtra.java</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6897bb;}
.s4 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
WebViewExtra.java</font>
</center></td></tr></table>
<pre><span class="s0">package </span><span class="s1">uk.co.metricrat.webviewextra</span><span class="s0">;</span>

<span class="s2">// Juan Antonio Villalpando  - kio4.com</span>
<span class="s2">// com.KIO4_WebViewExtra</span>
<span class="s2">// TIMAI2 - ai2.metricrat.co.uk</span>
<span class="s2">// Enero 2023.</span>


<span class="s0">import </span><span class="s1">android.annotation.*</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">android.app.*</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">android.content.*</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">android.graphics.drawable.*</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">android.os.*</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">android.util.Base64</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">android.webkit.*</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">android.webkit.DownloadListener</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">android.widget.*</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">com.google.appinventor.components.annotations.*</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">com.google.appinventor.components.runtime.*</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">android.net.Uri</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">android.database.Cursor</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">android.provider.OpenableColumns</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">com.google.appinventor.components.runtime.util.*</span><span class="s0">;</span>

<span class="s0">import </span><span class="s1">java.io.*</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">java.io.File</span><span class="s0">;</span>
<span class="s0">import </span><span class="s1">java.util.*</span><span class="s0">;</span>

<span class="s0">import static </span><span class="s1">java.lang.System.currentTimeMillis</span><span class="s0">;</span>


<span class="s0">public class </span><span class="s1">WebViewExtra </span><span class="s0">extends </span><span class="s1">AndroidNonvisibleComponent </span><span class="s0">implements  </span><span class="s1">Component</span><span class="s0">, </span><span class="s1">ActivityResultListener {</span>
  <span class="s0">private final </span><span class="s1">ComponentContainer container</span><span class="s0">;</span>
  <span class="s0">private final </span><span class="s1">Activity activity</span><span class="s0">;</span>
  <span class="s0">private final </span><span class="s1">Context context</span><span class="s0">;</span>

  <span class="s0">private </span><span class="s1">ValueCallback&lt;Uri[]&gt; mFilePathCallback</span><span class="s0">;</span>
  <span class="s0">private static final int </span><span class="s1">RESULT_OK = </span><span class="s3">1</span><span class="s0">;</span>
  <span class="s0">protected int </span><span class="s1">requestCode</span><span class="s0">;</span>
  <span class="s0">private </span><span class="s1">WebSettings settings</span><span class="s0">;</span>
  <span class="s0">public </span><span class="s1">CookieManager cookieManager</span><span class="s0">;</span>
  <span class="s0">private </span><span class="s1">String nameFile = </span><span class="s4">&quot;&quot;</span><span class="s0">;</span>
  <span class="s0">private </span><span class="s1">String urlFile = </span><span class="s4">&quot;&quot;</span><span class="s0">;</span>
  <span class="s1">BroadcastReceiver  broadcastReceiver = </span><span class="s0">null;</span>
  <span class="s0">private boolean </span><span class="s1">downloadDirectory = </span><span class="s0">false;</span>
  <span class="s0">private boolean </span><span class="s1">uploadDirectory = </span><span class="s0">false;</span>
  <span class="s0">private </span><span class="s1">String[] asdFiles</span><span class="s0">;</span>
  <span class="s0">private </span><span class="s1">String asdPath</span><span class="s0">;</span>
  <span class="s0">boolean </span><span class="s1">transparentbg = </span><span class="s0">false;</span>
  <span class="s0">private </span><span class="s1">JavaScriptInterface jsInterface</span><span class="s0">;</span>
  <span class="s0">private </span><span class="s1">String blobMimeType = </span><span class="s4">&quot;&quot;</span><span class="s0">;</span>

  <span class="s0">public </span><span class="s1">WebViewExtra(ComponentContainer container) {</span>
    <span class="s0">super</span><span class="s1">(container.$form())</span><span class="s0">;</span>
    <span class="s0">this</span><span class="s1">.container = container</span><span class="s0">;</span>
    <span class="s1">context = (Context) container.$context()</span><span class="s0">;</span>
    <span class="s1">activity = (Activity) container.$context()</span><span class="s0">;</span>
    <span class="s1">cookieManager = CookieManager.getInstance()</span><span class="s0">;</span>
  <span class="s1">}</span>

<span class="s2">//TRANSBACK//</span>

  <span class="s1">@DesignerProperty(editorType=</span><span class="s4">&quot;boolean&quot;</span><span class="s0">, </span><span class="s1">defaultValue=</span><span class="s4">&quot;False&quot;</span><span class="s1">)</span>
  <span class="s1">@SimpleProperty(description = </span><span class="s4">&quot;make the background of the webview transparent&quot;</span><span class="s0">, </span><span class="s1">userVisible = </span><span class="s0">false </span><span class="s1">)</span>
  <span class="s0">public void </span><span class="s1">TransparentBackground(</span><span class="s0">boolean </span><span class="s1">transp) {transparentbg = transp</span><span class="s0">; </span><span class="s1">}</span>

  <span class="s2">//FUNCTIONS//</span>
  <span class="s1">@SuppressLint(</span><span class="s4">&quot;SetJavaScriptEnabled&quot;</span><span class="s1">)</span>
  <span class="s1">@SimpleFunction(description = </span><span class="s4">&quot;Sets the Webviewer to use, attach the component block&quot;</span><span class="s1">)</span>
  <span class="s0">public void </span><span class="s1">SetWebviewer(WebViewer webViewer){</span>

    <span class="s0">if </span><span class="s1">(Build.VERSION.SDK_INT &gt;= </span><span class="s3">34</span><span class="s1">) {</span>
      <span class="s1">activity.registerReceiver(broadcastReceiver</span><span class="s0">, new </span><span class="s1">IntentFilter(DownloadManager.ACTION_DOWNLOAD_COMPLETE)</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
      <span class="s1">activity.registerReceiver(broadcastReceiver</span><span class="s0">, new </span><span class="s1">IntentFilter(DownloadManager.ACTION_DOWNLOAD_COMPLETE))</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s1">broadcastReceiver = </span><span class="s0">new </span><span class="s1">BroadcastReceiver() {</span>
      <span class="s0">public void </span><span class="s1">onReceive(Context context</span><span class="s0">, </span><span class="s1">Intent intent) {</span>
      <span class="s1">}</span>
    <span class="s1">}</span><span class="s0">;</span>

    <span class="s1">WebView mWebView = (WebView) webViewer.getView()</span><span class="s0">;</span>
    <span class="s1">settings = mWebView.getSettings()</span><span class="s0">;</span>
    <span class="s1">cookieManager.setAcceptThirdPartyCookies(mWebView</span><span class="s0">, true</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">settings.setJavaScriptEnabled(</span><span class="s0">true</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">settings.setJavaScriptCanOpenWindowsAutomatically(</span><span class="s0">true</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">settings.setLoadWithOverviewMode(</span><span class="s0">true</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">settings.setUseWideViewPort(</span><span class="s0">true</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">settings.setAllowFileAccess(</span><span class="s0">true</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">settings.setDomStorageEnabled(</span><span class="s0">true</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">settings.setBuiltInZoomControls(</span><span class="s0">true</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">settings.setDisplayZoomControls(</span><span class="s0">true</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">settings.setSupportZoom(</span><span class="s0">true</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">String ua = settings.getUserAgentString()</span><span class="s0">;</span>
    <span class="s1">settings.setUserAgentString(ua.replace(</span><span class="s4">&quot;; wv&quot;</span><span class="s0">,</span><span class="s4">&quot;&quot;</span><span class="s1">).replace(</span><span class="s4">&quot;Mobile &quot;</span><span class="s0">,</span><span class="s4">&quot;&quot;</span><span class="s1">).replace(</span><span class="s4">&quot;Version/4.0&quot;</span><span class="s0">,</span><span class="s4">&quot;&quot;</span><span class="s1">))</span><span class="s0">;</span>
    <span class="s1">jsInterface = </span><span class="s0">new </span><span class="s1">JavaScriptInterface(context.getApplicationContext())</span><span class="s0">;</span>
    <span class="s1">mWebView.addJavascriptInterface(jsInterface</span><span class="s0">, </span><span class="s4">&quot;Android&quot;</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">mWebView.setWebChromeClient(</span><span class="s0">new </span><span class="s1">ChromeClient())</span><span class="s0">;</span>

    <span class="s0">if </span><span class="s1">(transparentbg) {</span>
      <span class="s1">mWebView.setBackgroundColor(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">;</span>
      <span class="s1">Drawable background = mWebView.getBackground()</span><span class="s0">;</span>
      <span class="s0">if </span><span class="s1">(background != </span><span class="s0">null</span><span class="s1">) {</span>
        <span class="s1">background.setAlpha(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s1">mWebView.setDownloadListener(</span><span class="s0">new </span><span class="s1">DownloadListener() {</span>
      <span class="s1">@Override</span>
      <span class="s0">public void </span><span class="s1">onDownloadStart(String url</span><span class="s0">, </span><span class="s1">String userAgent</span><span class="s0">, </span><span class="s1">String contentDisposition</span><span class="s0">, </span><span class="s1">String mimeType</span><span class="s0">, long </span><span class="s1">contentLength) {</span>

        <span class="s0">if </span><span class="s1">(url.startsWith(</span><span class="s4">&quot;blob&quot;</span><span class="s1">)) {</span>
          <span class="s1">blobMimeType = mimeType</span><span class="s0">;</span>
          <span class="s2">//https://techblogs.42gears.com/download-the-file-with-blob-url-in-android-webview/</span>
          <span class="s1">mWebView.loadUrl(jsInterface.GetBase64StringFromBlobUrl(url</span><span class="s0">, </span><span class="s1">blobMimeType))</span><span class="s0">;</span>

        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>

          <span class="s1">DownloadManager.Request req = </span><span class="s0">new </span><span class="s1">DownloadManager.Request(Uri.parse(url))</span><span class="s0">;</span>
          <span class="s1">req.setNotificationVisibility(DownloadManager.Request.VISIBILITY_VISIBLE_NOTIFY_COMPLETED)</span><span class="s0">;</span>
          <span class="s1">String cookies = CookieManager.getInstance().getCookie(url)</span><span class="s0">;</span>
          <span class="s1">req.addRequestHeader(</span><span class="s4">&quot;cookie&quot;</span><span class="s0">, </span><span class="s1">cookies)</span><span class="s0">;</span>
          <span class="s1">urlFile = url</span><span class="s0">;</span>
          <span class="s0">if </span><span class="s1">(contentDisposition.contains(</span><span class="s4">&quot;filename=&quot;</span><span class="s1">)) {</span>
            <span class="s1">nameFile = contentDisposition.split(</span><span class="s4">&quot;filename=</span><span class="s0">\&quot;</span><span class="s4">&quot;</span><span class="s1">)[</span><span class="s3">1</span><span class="s1">].split(</span><span class="s4">&quot;</span><span class="s0">\&quot;</span><span class="s4">&quot;</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">;</span>
          <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s1">nameFile = URLUtil.guessFileName(url</span><span class="s0">, </span><span class="s1">contentDisposition</span><span class="s0">, null</span><span class="s1">)</span><span class="s0">;</span>
          <span class="s1">}</span>
          <span class="s0">if </span><span class="s1">(downloadDirectory == </span><span class="s0">true</span><span class="s1">) {</span>
            <span class="s1">req.setDestinationInExternalFilesDir(context</span><span class="s0">, </span><span class="s4">&quot;/&quot;</span><span class="s0">, </span><span class="s1">nameFile)</span><span class="s0">;</span>
            <span class="s2">//https://stackoverflow.com/a/26621853/2030549</span>
          <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s1">req.setDestinationInExternalPublicDir(Environment.DIRECTORY_DOWNLOADS</span><span class="s0">, </span><span class="s1">nameFile)</span><span class="s0">;</span>
          <span class="s1">}</span>
          <span class="s1">Downloaded(urlFile</span><span class="s0">, </span><span class="s1">nameFile)</span><span class="s0">;</span>
          <span class="s1">DownloadDataDebug(url</span><span class="s0">, </span><span class="s1">userAgent</span><span class="s0">, </span><span class="s1">contentDisposition</span><span class="s0">, </span><span class="s1">mimeType</span><span class="s0">, </span><span class="s1">nameFile)</span><span class="s0">;</span>
          <span class="s1">DownloadManager dm = (DownloadManager) context.getSystemService(Context.DOWNLOAD_SERVICE)</span><span class="s0">;</span>

          <span class="s0">if </span><span class="s1">(Build.VERSION.SDK_INT &gt;= </span><span class="s3">34</span><span class="s1">) {</span>
            <span class="s1">activity.registerReceiver(broadcastReceiver</span><span class="s0">, new </span><span class="s1">IntentFilter(DownloadManager.ACTION_DOWNLOAD_COMPLETE)</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">;</span>
          <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s1">activity.registerReceiver(broadcastReceiver</span><span class="s0">, new </span><span class="s1">IntentFilter(DownloadManager.ACTION_DOWNLOAD_COMPLETE))</span><span class="s0">;</span>
          <span class="s1">}</span>

          <span class="s1">broadcastReceiver = </span><span class="s0">new </span><span class="s1">BroadcastReceiver() {</span>
            <span class="s0">public void </span><span class="s1">onReceive(Context context</span><span class="s0">, </span><span class="s1">Intent intent) {</span>
            <span class="s1">}</span>
          <span class="s1">}</span><span class="s0">;</span>

          <span class="s1">dm.enqueue(req)</span><span class="s0">;</span>
          <span class="s1">Toast.makeText(context.getApplicationContext()</span><span class="s0">, </span><span class="s4">&quot;Downloading....&quot;</span><span class="s0">, </span><span class="s1">Toast.LENGTH_SHORT).show()</span><span class="s0">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">})</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s0">public class </span><span class="s1">ChromeClient </span><span class="s0">extends </span><span class="s1">WebChromeClient {</span>
    <span class="s0">public boolean </span><span class="s1">onShowFileChooser(WebView view</span><span class="s0">, </span><span class="s1">ValueCallback&lt;Uri[]&gt; filePath</span><span class="s0">, </span><span class="s1">WebChromeClient.FileChooserParams fileChooserParams) {</span>

      <span class="s0">if </span><span class="s1">(mFilePathCallback != </span><span class="s0">null</span><span class="s1">) {</span>
        <span class="s1">mFilePathCallback.onReceiveValue(</span><span class="s0">null</span><span class="s1">)</span><span class="s0">;</span>
      <span class="s1">}</span>
      <span class="s1">mFilePathCallback = filePath</span><span class="s0">;</span>

      <span class="s1">click()</span><span class="s0">;</span>
      <span class="s0">return true;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">public void </span><span class="s1">click() {</span>
    <span class="s1">BeforePicking(fileType)</span><span class="s0">;</span>
    <span class="s0">if </span><span class="s1">(requestCode == </span><span class="s3">0</span><span class="s1">) {</span>
      <span class="s1">requestCode = container.$form().registerForActivityResult(</span><span class="s0">this</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>
    <span class="s0">if </span><span class="s1">( uploadDirectory == </span><span class="s0">false </span><span class="s1">) {</span>
      <span class="s1">container.$context().startActivityForResult(getIntent()</span><span class="s0">, </span><span class="s1">requestCode)</span><span class="s0">;</span>
    <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
      <span class="s1">container.$context().startActivityForResult(getIntentLPI()</span><span class="s0">, </span><span class="s1">requestCode)</span><span class="s0">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">protected </span><span class="s1">Intent getIntentLPI () {</span>
    <span class="s1">Intent lpi = </span><span class="s0">new </span><span class="s1">Intent()</span><span class="s0">;</span>
    <span class="s1">lpi.setClassName(container.$context()</span><span class="s0">, </span><span class="s4">&quot;com.google.appinventor.components.runtime.ListPickerActivity&quot;</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">lpi.putExtra(</span><span class="s4">&quot;com.google.appinventor.components.runtime.ListPickerActivity.list&quot;</span><span class="s0">, </span><span class="s1">asdFiles)</span><span class="s0">;</span>
    <span class="s0">return </span><span class="s1">lpi</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s0">protected </span><span class="s1">Intent getIntent() {</span>
    <span class="s1">Intent i = </span><span class="s0">new </span><span class="s1">Intent(Intent.ACTION_GET_CONTENT)</span><span class="s0">;</span>
    <span class="s1">i.addCategory(Intent.CATEGORY_OPENABLE)</span><span class="s0">;</span>
    <span class="s1">i.setType(fileType)</span><span class="s0">;</span>
    <span class="s0">return </span><span class="s1">Intent.createChooser(i</span><span class="s0">, </span><span class="s4">&quot;File Chooser&quot;</span><span class="s1">)</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s0">public void </span><span class="s1">resultReturned(</span><span class="s0">int </span><span class="s1">requestCode</span><span class="s0">, int </span><span class="s1">resultCode</span><span class="s0">, </span><span class="s1">Intent data) {</span>
    <span class="s1">Uri[] results = </span><span class="s0">null;</span>
    <span class="s1">String dataString</span><span class="s0">;</span>

    <span class="s0">if </span><span class="s1">(resultCode == Activity.RESULT_OK) {</span>
      <span class="s0">if </span><span class="s1">(uploadDirectory) {</span>
        <span class="s1">Uri uri = Uri.parse(asdPath + data.getStringExtra(</span><span class="s4">&quot;com.google.appinventor.components.runtime.ListPickerActivity.selection&quot;</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">dataString = String.valueOf(uri)</span><span class="s0">;</span>
      <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
        <span class="s1">dataString = data.getDataString()</span><span class="s0">;</span>
      <span class="s1">}</span>

      <span class="s0">if </span><span class="s1">(dataString != </span><span class="s0">null</span><span class="s1">) {</span>
        <span class="s1">results = </span><span class="s0">new </span><span class="s1">Uri[]{Uri.parse(dataString)}</span><span class="s0">;</span>
        <span class="s1">AfterPicking(getFileName(Uri.parse(dataString)))</span><span class="s0">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s1">mFilePathCallback.onReceiveValue(results)</span><span class="s0">;</span>
    <span class="s1">mFilePathCallback = </span><span class="s0">null;</span>
  <span class="s1">}</span>

  <span class="s0">public </span><span class="s1">String getFileName(Uri uri) {</span>
    <span class="s1">String result = </span><span class="s0">null;</span>
    <span class="s0">if </span><span class="s1">(uri.getScheme().equals(</span><span class="s4">&quot;content&quot;</span><span class="s1">)) {</span>
      <span class="s0">try </span><span class="s1">(Cursor cursor = context.getContentResolver().query(uri</span><span class="s0">, null, null, null, null</span><span class="s1">)) {</span>
        <span class="s0">if </span><span class="s1">(cursor != </span><span class="s0">null </span><span class="s1">&amp;&amp; cursor.moveToFirst()) {</span>
          <span class="s1">result = cursor.getString(cursor.getColumnIndex(OpenableColumns.DISPLAY_NAME))</span><span class="s0">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s0">if </span><span class="s1">(result == </span><span class="s0">null</span><span class="s1">) {</span>
      <span class="s1">result = uri.getPath()</span><span class="s0">;</span>
      <span class="s0">int </span><span class="s1">cut = result.lastIndexOf(</span><span class="s4">'/'</span><span class="s1">)</span><span class="s0">;</span>
      <span class="s0">if </span><span class="s1">(cut != -</span><span class="s3">1</span><span class="s1">) {</span>
        <span class="s1">result = result.substring(cut + </span><span class="s3">1</span><span class="s1">)</span><span class="s0">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s0">return </span><span class="s1">result</span><span class="s0">;</span>
  <span class="s1">}</span>



  <span class="s1">@SimpleFunction(description = </span><span class="s4">&quot;Returns file type for picking files for upload. Will only apply if selecting from Shared Directories.&quot;</span><span class="s1">)</span>
  <span class="s0">public void </span><span class="s1">FileType(String filetype) {</span>
    <span class="s0">if </span><span class="s1">(!filetype.equals(</span><span class="s4">&quot;*/*&quot;</span><span class="s1">)) { fileType = filetype</span><span class="s0">; </span><span class="s1">}</span>
    <span class="s1">BeforePicking(fileType)</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s1">@SimpleFunction(description=</span><span class="s4">&quot;Set true or false for ZoomControls in the webviewer - true by default.&quot;</span><span class="s1">)</span>
  <span class="s0">public void </span><span class="s1">ZoomControls(</span><span class="s0">boolean </span><span class="s1">enabled){</span>
    <span class="s1">settings.setBuiltInZoomControls(enabled)</span><span class="s0">;</span>
    <span class="s1">settings.setDisplayZoomControls(enabled)</span><span class="s0">;</span>
    <span class="s1">settings.setSupportZoom(enabled)</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s1">@SimpleFunction(description=</span><span class="s4">&quot;Set true or false for WideViewPort in the webviewer, that is, enable support for the viewport HTML meta tag or should use a wide viewport - true by default.&quot;</span><span class="s1">)</span>
  <span class="s0">public void </span><span class="s1">WideViewportMode(</span><span class="s0">boolean </span><span class="s1">enabled){</span>
    <span class="s1">settings.setUseWideViewPort(enabled)</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s1">@SimpleFunction(description=</span><span class="s4">&quot;Set true or false for LoadWithOverview in the webviewer, that is, zooms out the content to fit on screen by width - true by default.&quot;</span><span class="s1">)</span>
  <span class="s0">public void </span><span class="s1">LoadWithOverviewMode(</span><span class="s0">boolean </span><span class="s1">enabled){</span>
    <span class="s1">settings.setLoadWithOverviewMode(enabled)</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s1">@SimpleFunction(description=</span><span class="s4">&quot;Set true to download to ASD, or false to use Download directory.  - false by default.&quot;</span><span class="s1">)</span>
  <span class="s0">public void </span><span class="s1">DownloadToASD(</span><span class="s0">boolean </span><span class="s1">enabled){</span>
    <span class="s1">downloadDirectory = enabled</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s1">@SimpleFunction(description=</span><span class="s4">&quot;Set true to upload from ASD, or false to use Shared directories.  - false by default.&quot;</span><span class="s1">)</span>
  <span class="s0">public void </span><span class="s1">UploadFromASD(</span><span class="s0">boolean </span><span class="s1">enabled){</span>
    <span class="s1">uploadDirectory = enabled</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s1">@SimpleFunction(description=</span><span class="s4">&quot;return all files in ASD&quot;</span><span class="s1">)</span>
  <span class="s0">public void </span><span class="s1">GetAsdFiles(YailList fileNames</span><span class="s0">,</span><span class="s1">String pathToASD){</span>
    <span class="s1">asdPath = pathToASD</span><span class="s0">;</span>
    <span class="s1">asdFiles = fileNames.toStringArray()</span><span class="s0">;</span>
    <span class="s1">String stringAsdFiles = toString(asdFiles)</span><span class="s0">;</span>
    <span class="s1">GotASDFiles(stringAsdFiles)</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s0">public static </span><span class="s1">String toString(Object[] a) {</span>
    <span class="s0">if </span><span class="s1">(a == </span><span class="s0">null</span><span class="s1">)</span>
      <span class="s0">return </span><span class="s4">&quot;null&quot;</span><span class="s0">;</span>

    <span class="s0">int </span><span class="s1">iMax = a.length - </span><span class="s3">1</span><span class="s0">;</span>
    <span class="s0">if </span><span class="s1">(iMax == -</span><span class="s3">1</span><span class="s1">)</span>
      <span class="s0">return </span><span class="s4">&quot;[]&quot;</span><span class="s0">;</span>

    <span class="s1">StringBuilder b = </span><span class="s0">new </span><span class="s1">StringBuilder()</span><span class="s0">;</span>
    <span class="s1">b.append(</span><span class="s4">'['</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s0">for </span><span class="s1">(</span><span class="s0">int </span><span class="s1">i = </span><span class="s3">0</span><span class="s0">; ; </span><span class="s1">i++) {</span>
      <span class="s1">b.append(String.valueOf(a[i]))</span><span class="s0">;</span>
      <span class="s0">if </span><span class="s1">(i == iMax)</span>
        <span class="s0">return </span><span class="s1">b.append(</span><span class="s4">']'</span><span class="s1">).toString()</span><span class="s0">;</span>
      <span class="s1">b.append(</span><span class="s4">&quot;, &quot;</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

<span class="s2">//FUNCTIONS END//</span>

<span class="s2">//PROPERTIES//</span>

  <span class="s1">@SimpleProperty(description = </span><span class="s4">&quot;Get the current setting for UserAgent in the webviewer&quot;</span><span class="s1">)</span>
  <span class="s0">public </span><span class="s1">String GetUserAgentString() {</span><span class="s0">return </span><span class="s1">settings.getUserAgentString()</span><span class="s0">;</span><span class="s1">}</span>

  <span class="s1">@SimpleProperty(description = </span><span class="s4">&quot;Get the current setting for Zoom Controls in the webviewer&quot;</span><span class="s1">)</span>
  <span class="s0">public boolean </span><span class="s1">ZoomControls() {</span><span class="s0">return </span><span class="s1">settings.getDisplayZoomControls()</span><span class="s0">;</span><span class="s1">}</span>

  <span class="s1">List&lt; String&gt; fileTypes = Arrays.asList(</span><span class="s4">&quot;*/*&quot;</span><span class="s0">,</span><span class="s4">&quot;image/*&quot;</span><span class="s0">, </span><span class="s4">&quot;audio/*&quot;</span><span class="s0">, </span><span class="s4">&quot;video/*&quot;</span><span class="s0">, </span><span class="s4">&quot;application/pdf&quot;</span><span class="s0">, </span><span class="s4">&quot;image/png&quot;</span><span class="s0">, </span><span class="s4">&quot;image/jpg&quot;</span><span class="s0">, </span><span class="s4">&quot;text/*&quot;</span><span class="s0">,</span><span class="s4">&quot;text/csv&quot;</span><span class="s1">)</span><span class="s0">;</span>

  <span class="s1">@SimpleProperty(description = </span><span class="s4">&quot;List of file types to select from&quot;</span><span class="s1">)</span>
  <span class="s0">public </span><span class="s1">List &lt; String&gt; FileTypes() {</span>
    <span class="s0">return </span><span class="s1">fileTypes</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s1">String fileType = </span><span class="s4">&quot;*/*&quot;</span><span class="s0">;</span>

<span class="s2">//PROPERTIES END//</span>

<span class="s2">//EVENTS//</span>

  <span class="s1">@SimpleEvent(description=</span><span class="s4">&quot;Do something before picking a file for upload, and returns filetype chosen for selecting file for upload&quot;</span><span class="s1">)</span>
  <span class="s0">public void </span><span class="s1">BeforePicking(String fileTypeChosen) {</span>
    <span class="s1">EventDispatcher.dispatchEvent(</span><span class="s0">this, </span><span class="s4">&quot;BeforePicking&quot;</span><span class="s0">, </span><span class="s1">fileTypeChosen)</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s1">@SimpleEvent(description=</span><span class="s4">&quot;Do something after selecting a file for upload, and returns filename AFTER selecting for upload&quot;</span><span class="s1">)</span>
  <span class="s0">public void </span><span class="s1">AfterPicking(String nameFile) {</span>
    <span class="s1">EventDispatcher.dispatchEvent(</span><span class="s0">this, </span><span class="s4">&quot;AfterPicking&quot;</span><span class="s0">, </span><span class="s1">nameFile)</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s1">@SimpleEvent(description=</span><span class="s4">&quot;Returns download data, intended for developer use&quot;</span><span class="s1">)</span>
  <span class="s0">public void </span><span class="s1">DownloadDataDebug(String url</span><span class="s0">, </span><span class="s1">String userAgent</span><span class="s0">,</span><span class="s1">String contentDisposition</span><span class="s0">,</span><span class="s1">String mimeType</span><span class="s0">,</span><span class="s1">String filename ){</span>
    <span class="s1">EventDispatcher.dispatchEvent(</span><span class="s0">this, </span><span class="s4">&quot;DownloadDataDebug&quot;</span><span class="s0">, </span><span class="s1">url</span><span class="s0">,</span><span class="s1">userAgent</span><span class="s0">,</span><span class="s1">contentDisposition</span><span class="s0">,</span><span class="s1">mimeType</span><span class="s0">,</span><span class="s1">filename)</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s1">@SimpleEvent(description=</span><span class="s4">&quot;Returns url and filename AFTER download&quot;</span><span class="s1">)</span>
  <span class="s0">public void </span><span class="s1">Downloaded(String url</span><span class="s0">, </span><span class="s1">String filename) {</span>
    <span class="s1">EventDispatcher.dispatchEvent(</span><span class="s0">this, </span><span class="s4">&quot;Downloaded&quot;</span><span class="s0">, </span><span class="s1">url</span><span class="s0">, </span><span class="s1">filename)</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s1">@SimpleEvent(description=</span><span class="s4">&quot;got Files in ASD&quot;</span><span class="s1">)</span>
  <span class="s0">public void </span><span class="s1">GotASDFiles(String files) {</span>
    <span class="s1">EventDispatcher.dispatchEvent(</span><span class="s0">this, </span><span class="s4">&quot;GotASDFiles&quot;</span><span class="s0">,</span><span class="s1">files)</span><span class="s0">;</span>
  <span class="s1">}</span>

  <span class="s2">//EVENTS END//</span>

  <span class="s2">//##############################################</span>
  <span class="s2">//# JAVASCRIPT INTERFACE AND BLOB URL DOWNLOAD #</span>
  <span class="s2">//##############################################</span>

  <span class="s0">public class </span><span class="s1">JavaScriptInterface {</span>
    <span class="s0">private final </span><span class="s1">Context context</span><span class="s0">;</span>
    <span class="s0">public </span><span class="s1">JavaScriptInterface(Context context) {</span>
      <span class="s0">this</span><span class="s1">.context = context</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s1">@android.webkit.JavascriptInterface</span>
    <span class="s0">public void </span><span class="s1">getBase64FromBlobData(String base64Data) </span><span class="s0">throws </span><span class="s1">IOException</span><span class="s0">, </span><span class="s1">InterruptedException {</span>
      <span class="s1">Toast.makeText(context.getApplicationContext()</span><span class="s0">, </span><span class="s4">&quot;got base64 from blob&quot;</span><span class="s0">, </span><span class="s1">Toast.LENGTH_SHORT).show()</span><span class="s0">;</span>
      <span class="s1">activity.runOnUiThread(</span><span class="s0">new </span><span class="s1">Runnable() {</span>
        <span class="s0">public void </span><span class="s1">run() {</span>
          <span class="s0">try </span><span class="s1">{</span>
            <span class="s1">convertBase64StringToFileAndStoreIt(base64Data</span><span class="s0">, </span><span class="s1">blobMimeType)</span><span class="s0">;</span>
          <span class="s1">} </span><span class="s0">catch </span><span class="s1">(IOException e) {</span>
            <span class="s0">throw new </span><span class="s1">RuntimeException(e)</span><span class="s0">;</span>
          <span class="s1">} </span><span class="s0">catch </span><span class="s1">(InterruptedException e) {</span>
            <span class="s0">throw new </span><span class="s1">RuntimeException(e)</span><span class="s0">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">})</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public </span><span class="s1">String GetBase64StringFromBlobUrl(String blobUrl</span><span class="s0">, </span><span class="s1">String mimeType) {</span>
      <span class="s0">return </span><span class="s4">&quot;javascript: var xhr = new XMLHttpRequest();&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;xhr.open('GET', '&quot; </span><span class="s1">+ blobUrl + </span><span class="s4">&quot;', true);&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;xhr.setRequestHeader('Content-type','&quot; </span><span class="s1">+ mimeType + </span><span class="s4">&quot;;charset=UTF-8');&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;xhr.responseType = 'blob';&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;xhr.onload = function(e) {&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;    if (this.status == 200) {&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;        var blobFile = this.response;&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;        var reader = new FileReader();&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;        reader.readAsDataURL(blobFile);&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;        reader.onloadend = function() {&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;            base64data = reader.result;&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;            window.Android.getBase64FromBlobData(base64data);&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;        }&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;    }&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;};&quot; </span><span class="s1">+</span>
              <span class="s4">&quot;xhr.send();&quot;</span><span class="s0">;</span>
    <span class="s1">}</span>
    <span class="s0">public void </span><span class="s1">convertBase64StringToFileAndStoreIt(String base64String</span><span class="s0">, </span><span class="s1">String mimeType) </span><span class="s0">throws </span><span class="s1">IOException</span><span class="s0">, </span><span class="s1">InterruptedException {</span>
      <span class="s1">BufferedOutputStream output = </span><span class="s0">null;</span>
      <span class="s1">String newTime = String.valueOf(currentTimeMillis())</span><span class="s0">;</span>
      <span class="s1">MimeTypeMap mimeTypeMap = MimeTypeMap.getSingleton()</span><span class="s0">;</span>
      <span class="s1">String extension = mimeTypeMap.getExtensionFromMimeType(mimeType)</span><span class="s0">;</span>
      <span class="s1">String filenameBlob = </span><span class="s4">&quot;file_&quot; </span><span class="s1">+ newTime + </span><span class="s4">&quot;.&quot; </span><span class="s1">+ extension</span><span class="s0">;</span>
      <span class="s0">final </span><span class="s1">java.io.File dwldsPath = </span><span class="s0">new </span><span class="s1">File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS) + </span><span class="s4">&quot;/&quot; </span><span class="s1">+ filenameBlob)</span><span class="s0">;</span>
      <span class="s1">String source = base64String.split(</span><span class="s4">&quot;,&quot;</span><span class="s1">)[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">;</span>
      <span class="s0">byte</span><span class="s1">[] fileAsBytes = Base64.decode(source</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">;</span>
      <span class="s1">FileOutputStream os = </span><span class="s0">new </span><span class="s1">FileOutputStream(dwldsPath</span><span class="s0">, false</span><span class="s1">)</span><span class="s0">;</span>
      <span class="s1">os.write(fileAsBytes)</span><span class="s0">;</span>
      <span class="s1">os.flush()</span><span class="s0">;</span>

      <span class="s1">Toast.makeText(context.getApplicationContext()</span><span class="s0">, </span><span class="s4">&quot;Downloading blob to file ...&quot;</span><span class="s0">, </span><span class="s1">Toast.LENGTH_SHORT).show()</span><span class="s0">;</span>
      <span class="s1">Downloaded(urlFile</span><span class="s0">, </span><span class="s4">&quot;/storage/emulated/0/Download/&quot; </span><span class="s1">+ filenameBlob)</span><span class="s0">;</span>

    <span class="s1">}</span>

  <span class="s1">}</span>
<span class="s1">}</span></pre>
</body>
</html>